# Выбор базового образа
FROM python:3.12-slim-bookworm

# Переменные окружения
# Отключает буферизацию вывода для всех потоков
ENV PYTHONUNBUFFERED 1

# Текущая рабочая директория
WORKDIR /app

# Объявление портов
EXPOSE 8000

# Выполнение команд на этапах сборки образа
# - добавление нового пользователя user
RUN useradd -s /usr/sbin/nologin user

# Копирование файлов в образ
# - файл с зафиксированными версиями зависимостей
COPY ./requirements.txt .

# Выполнение команд на этапах сборки образа
# - установка зависимостей
RUN pip install \
        --no-cache-dir \
        --disable-pip-version-check \
        -r requirements.txt
# Копирование файлов в образ
# - все файлы проекта
COPY . .

# Переключаем пользователя,
# чтобы запуск процесса был от не привилегированного пользователя
USER user

# Команда по умолчанию при запуске контейнера
CMD ["gunicorn", "-b", "0.0.0.0", "mysite.wsgi"]
