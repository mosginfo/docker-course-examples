# Урок 12. Управление конфиденциальными данными

- [Определение секретов в compose.yml](#определение-секретов-в-composeyml)
- [Доступ к секретам во время сборки](#доступ-к-секретам-во-время-сборки)
  - [Почему не стоит использовать переменные времени сборки?](#почему-не-стоит-использовать-переменные-времени-сборки)
- [Доступ к SSH ключам во время сборки](#доступ-к-ssh-ключам-во-время-сборки)
- [Ссылки](#ссылки)

## Определение секретов в compose.yml

Веб приложение на Flask, которое ведет журнал посещаемости в MongoDB.
Для каждого клиента в журнал добавляется запись о IP, браузере и времени посещения.

Имя пользователя и пароль для подключения к БД - это конфиденциальные данные.

```shell
# Сборка проекта
./bin/build.sh

# Запуск проекта
docker compose up -d

# Проверка работоспособности
curl 127.0.0.1
```

## Доступ к секретам во время сборки

При сборке образа необходимо установить Python пакет из частного реестра.
Для доступа к реестру нужно знать имя пользователя и пароль - это конфиденциальные данные.

```shell
# Генерация файла htpasswd с пользователем user и паролем test
docker run --rm -ti httpd:2.4-alpine3.19 htpasswd -nb user test > ./pypi-server/secrets/htpasswd

# Запуск частного реестра
docker compose --project-directory ./pypi-server up -d


# Генерация файла-секрета для аргумента indexurl
echo "http://user:test@$(hostname -I | awk '/^192/ {print $1}'):8080" > ./image/secrets/indexurl

# Сборка образа с указанием файла-секрета
docker build -t example-mount-secret --secret id=indexurl,src=./image/secrets/indexurl ./image

# Проверка установленного пакета
docker run --rm example-mount-secret pip freeze | grep kirill-vercetti
```

### Почему не стоит использовать переменные времени сборки?

1. Переменные времени сборки передаются на этапе сборки образа Docker и могут быть включены в слои образа.
   Даже если переменные не видны непосредственно в итоговом образе/запущенном контейнере,
   они могут быть восстановлены из промежуточных слоев образа.

1. Docker хранит историю изменений каждого слоя образа, включая команды сборки и использованные переменные.
   С помощью команды `docker history` можно увидеть, какие переменные использовались на этапе сборки.

1. Переменные времени сборки могут быть сохранены в кеше сборки,
   что приводит к потенциальной утечке конфиденциальных данных при последующих сборках, если кеш не был сброшен.

1. Переменные времени сборки могут попасть в лог-файлы, в историю команд или в стандартный поток вывода,
   что делает их доступными для других пользователей системы.

## Доступ к SSH ключам во время сборки

При сборке образа вам может потребоваться клонировать приватные репозитории.
С помощью аргумента `--ssh` команды `docker build` можно передать SSH ключи,
чтобы Docker мог аутентифицироваться и получить доступ к этим репозиториям.

Другой пример, с помощью NPM установить пакет из приватные Git репозитория, используя SSH ключ.

SSH ключи - это конфиденциальные данные, копировать их в образ опасно.
Можно временно предоставить доступ к ключам через SSH-агент.
Это уменьшает риск утечки ключей.

С помощью аргумента `--ssh` можно указать местоположение локального сокета SSH-агента
или закрытых ключей, которые будут доступны для сборки.

Если путь не указан, то используется значение переменной окружения `$SSH_AUTH_SOCK`.
Чтобы сработала конфигурация по умолчанию, нужно добавить свои ключи в локальный SSH-агент.
С помощью команды `ssh-add -L` вы можете посмотреть список добавленных ключей.

Если вы не хотите использовать SSH-агент, можно явно указать путь к приватному ключу `--ssh default=$HOME/.ssh/id_rsa`.
Здесь используется приватный ключ из домашней директории текущего пользователя с именем `id_rsa`.

```shell
# Сборка образа
docker build -t example-mount-ssh --ssh=default=$HOME/.ssh/id_rsa .

# Проверка установленного пакета
docker run --rm example-mount-ssh npm list | grep api-call-simplifier
```

## Ссылки
